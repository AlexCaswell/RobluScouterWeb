<!DOCTYPE html>
<html>
<head>
	<title>Roblu Scouter Web Interface </title>

	<!-- Materilize -->
	<!--Import Google Icon Font-->
  	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen,projection"/>

	<link rel="shortcut icon" type="img/png" href="favicon.png"> 

  	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<!-- import jquery -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>
<body>
 	<nav class="nav-extended" style="position: fixed; top: 0; left: 0; z-index: 1000;">
 		<div class="nav-wrapper">
      		<a href="#" id="title" style="font-size: 1.6rem; padding: 20px 0 5px 20px; display: block; line-height: 1.6rem;"><br></a>
      		<a href="#" id="active_event_label" style="font-size: 1.1rem; padding: 0 0 10px 25px; display: block; line-height: 1.1rem;"><br></a>

      		<!-- settings button and menu -->
			<a href="#" id="settings_button" data-activates='settings_list' class="dropdown-button" style="position: absolute; top: 5px; right: 15px;"><i class="material-icons">more_vert</i></a>
      		<ul style="margin-top: 20px; margin-right: 30px; background: #546E7A; min-width: 250px;" id="settings_list" class="dropdown-content"><style type="text/css">#settings_list li a { color: #FFF; }</style>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts(0, 30)" class="filled-in checkbox-color" id="show_pit_checkouts" checked="checked" />
						<label style="color: #FFF;" for="show_pit_checkouts">Show pit checkouts</label>
					</a>
      			</li>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts(0, 30)" class="filled-in checkbox-color" id="show_completed_checkouts" checked="checked"/>
						<label style="color: #FFF;" for="show_completed_checkouts">Show completed</label>
					</a>
      			</li>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts(0, 30)" class="filled-in checkbox-color" id="show_checked_out" checked="checked"/>
						<label style="color: #FFF;" for="show_checked_out">Show checked out</label>
					</a>
      			</li>
      			<li><a id="settings" href="settings.html">Settings</a></li>
      		</ul>
      		<!-- change textbox color -->
      		<style type="text/css">
      			.checkbox-color[type='checkbox'].filled-in:checked + label:after {
      				background: #444;
      				border: #444;
      			}
      		</style>

  		</div>

  		<!-- tab selector -->
	    <div class="nav-content">
	      <ul class="tabs tabs-transparent">
	        <li class="tab"><a id="mc_a" href="#my_checkouts">My Checkouts</a></li>
	        <li class="tab"><a id="c_a" onclick="loadCheckouts(0, 30);" class="active" href="#checkouts">Checkouts</a></li>
	      </ul>
	    </div>
 	</nav><br><br><br><br><br><br>

 	<!-- "Checkouts" tab -->
 	<div id="checkouts" class="col s12" style="margin: 0 3% 0 3%;"></div>
 	<!-- "My Checkouts" tab -->
 	<div id="my_checkouts" class="col s12" style="margin: 0 3% 0 3%;"></div>


<!-- UI -->
<script type="text/javascript">

	// UI setting defaults
	var primaryColor = "#3F51B5";
	var cardColor = "#444444";
	var backgroundColor = "#303030";


	$(document).ready(function() {


		//set correct tab to active
		var eurl = new URL(window.location.href);
		if (eurl.searchParams.get("tab") == "myCheckouts") {
			$("#mc_a").attr("class", "active");
		}

		// Make sure browser is compatible with settings storage method (localStorage)
		if(typeof(Storage) === "undefined") {
			window.location.replace("error.html");
		}else {
			loadDefaultsIfNeeded();
		}

		// initialize settings dropdown
		$('.dropdown-button').dropdown({
			inDuration: 300,
			outDuration: 225,
			constrainWidth: false,
			hover: false,
			gutter: 0,
			belowOrigin: true,
			alignment: 'right',
			stopPropagation: false
		});


		// set Ui colors
		$(".card").attr("style", "background: " + cardColor + " !important;");
		$("nav").attr("style", $("nav").attr("style") + " background: " + primaryColor + " !important;");
		$("body").attr("style", "background: " + backgroundColor + " !important;");
		$("#settings_list").attr("style", $("#settings_list").attr("style") + " background-color: " + backgroundColor + " !important;");

		// Set scouter role from settings
		var title = "Roblu Scouter";
		if (localStorage.getItem("autoCheckoutMode") != 0) {
			title += " - " + getAutoCheckoutModeString(localStorage.getItem("autoCheckoutMode"));
		}
		$("#title").text(title);


		// Set active event name from server
		getTeamModel( function(data) {
			$("#active_event_label").text(data.active_event_name);
		});

		// load depending on isActive
		getIsActive( function( isActive ) {
			if(isActive == true) {
				pullCheckouts();
				setInterval(function () { pullCheckouts(); }, 10000); //call the pullCheckouts function periodically

				loadCheckouts(0, 30); //load main checkouts from server
				autoCheckout(); //add checkouts with matching autoCheckoutMode to myCheckouts localStorage item
			} else {
				Materialize.toast("No active event.", 2500);
			}
		});

		loadMyCheckouts(0, 30); //load checkouts from myCheckouts localStorage item into my_checkous div

 	});

</script>

<script type="text/javascript">

// loads checkouts from the server into the checkouts div
function loadCheckouts(start, limit) {

	//Clear checkouts div
	if(start == 0) {
		$("#checkouts").html("");
	}

	//Get settings from checkboxes
	var show_pit_checkouts = $("#show_pit_checkouts").is(':checked');
	var show_completed_checkouts = $("#show_completed_checkouts").is(':checked');
	var show_checked_out = $("#show_checked_out").is(':checked');

	//load checkouts from server into checkouts div
	filterCheckouts(show_pit_checkouts, show_completed_checkouts, show_checked_out, '0', function( checkouts ) {
		if(limit > checkouts.length) { limit = checkouts.length; }
		for(var i = start; i < limit; i++) {

			var checkout = checkouts[i];
			var checkout_content = JSON.parse(checkouts[i].content);

			var status;
			if(checkout_content.status == 0 || checkout_content.status == -1) {
				status = "Available";
			}
			if (checkout_content.status == 1) {
				status = "Checked out to " + checkout_content.nameTag;
			}
			if (checkout_content.status == 2) {
				status = "Completed"
			}
			var params = {
				team: checkout_content.team.name,
				type: checkout_content.team.tabs[0].matchType,
				match_order: checkout_content.team.tabs[0].matchOrder,
				cardColor: cardColor,
				available: status,
				onclick: "openCheckout(" + checkout.id + ", false);",
				checked_out: false,
				checkout: JSON.stringify(checkout),
				id: checkout.id
			};
			$("#checkouts").html($("#checkouts").html() + get_checkout(params));
		}
		if(limit != checkouts.length) {
			var html = get_load_more(limit, limit + 30, false);
			setTimeout(function () { $("#checkouts").html($("#checkouts").html() + html); }, 30); // add a "load more" button at the end if not already there
		}

	});
}


//
function filterCheckouts(showPitCheckouts, showCompletedCheckouts, showCheckedOut, deviceRole, callback) {

	var data = JSON.parse(localStorage.getItem("checkouts"));

    // filter checkouts by device role
    var sorted_checkouts_d = [];
  	var index = 0;

  	if(deviceRole != 0) {
    	for(var i = 0; i < data.length; i++) {
    		var checkout = JSON.parse(data[i].content);

    		// Pit role
	    	if(checkout.team.tabs[0].matchType == "PIT" && deviceRole != 7) { continue; }
	    	// Blue 3 role
	    	if(checkout.team.tabs[0].alliancePosition == 6 && deviceRole != 6) { continue; }
	    	// Blue 2 role
	    	if(checkout.team.tabs[0].alliancePosition == 5 && deviceRole != 5) { continue; }
	    	// Blue 1 role
	    	if(checkout.team.tabs[0].alliancePosition == 4 && deviceRole != 4) { continue; }
	    	// Red 3 role
	    	if(checkout.team.tabs[0].alliancePosition == 3 && deviceRole != 3) { continue; }
	    	// Red 2 role
	    	if(checkout.team.tabs[0].alliancePosition == 2 && deviceRole != 2) { continue; }
	    	// Red 1 role
	    	if(checkout.team.tabs[0].alliancePosition == 1 && deviceRole != 1) { continue; }

    		sorted_checkouts_d[index] = data[i];
    		index++;
		}
	}else {
		sorted_checkouts_d = data; // if device role is 0 no filtering is needed.
	}


	// filter remaining checkouts based on "checkbox variables"
	var sorted_checkouts_dc = [];
	index = 0;

    for (var i = 0; i < sorted_checkouts_d.length; i++) {
    	var checkout = sorted_checkouts_d[i];
    	var checkout_content = JSON.parse(sorted_checkouts_d[i].content);

    	// Filter pit checkouts
    	if(!showPitCheckouts && checkout_content.team.tabs[0].matchType == "PIT") { continue; }
    	// Filter comleted checkouts
    	if(!showCompletedCheckouts && checkout.status == 2) { continue; }
    	// Filter checked out
    	if(!showCheckedOut && checkout.status == 1) { continue; }

		sorted_checkouts_dc[index] = checkout;
		index++;
    }


	//return sorted checkouts
	callback(sorted_checkouts_dc);

}

//adds all checkouts with the matching device role to myCheckouts item (must be run after checkouts are loaded into localStorage item)
function autoCheckout() {
	if(localStorage.getItem("autoCheckoutModeTemp") != localStorage.getItem("autoCheckoutMode")) {

		//remove old device role checkouts and change status' to 0
		// release status'
		uploadMyCheckouts(true);
		// remove item
		localStorage.removeItem("myCheckouts");
		localStorage.setItem("autoCheckoutModeTemp", localStorage.getItem("autoCheckoutMode"));

		if(localStorage.getItem("autoCheckoutMode") != '0') {
		
			filterCheckouts(true, true, true, localStorage.getItem("autoCheckoutMode"), function( checkouts ) {
				for(var i = 0; i < checkouts.length; i++) {
					//load myCheckouts array
					var my_checkouts = [];
					if(localStorage.getItem("myCheckouts") === null) {
						localStorage.setItem("myCheckouts", JSON.stringify(my_checkouts));
					}else {
						my_checkouts = JSON.parse(localStorage.getItem("myCheckouts"));
					}

					//make sure checkout is not already checked out
					var available = false;
					var unique = false;
					var j = 0;
					do {
						if(my_checkouts.length == 0) {
							unique = true;
						}else if(checkouts[i].id != my_checkouts[j].id) {
							unique = true;
						}else {
							unique = false; break;
						}
						j++;
					}while(j < my_checkouts.length);

					// if(!unique || checkouts[i].status == 1 ||  checkouts[i].status == 2) { available = false; } else { available = true; }
					if(!unique) { available = false; } else { available = true; }

					if(available) {
						//update status
						var ck_content = JSON.parse(checkouts[i].content);
						ck_content.nameTag = localStorage.getItem("username");
						ck_content.status = 1;
						checkouts[i].content = JSON.stringify(ck_content);
						//add checkout to array
						my_checkouts[my_checkouts.length] = checkouts[i];

						//serialize and store array
						localStorage.setItem("myCheckouts", JSON.stringify(my_checkouts));
					}
				}
				loadMyCheckouts(0, 30); //refresh html
				uploadMyCheckouts(false); //sync status' with server
			});
		}
	}
}

//upload a single checkout with status 2
function completeCheckout(id) {
	var checkout = JSON.parse($("#my_checkouts").find(".card").find(".card-content").find("#" + id).attr("checkout"));
	$("#my_checkouts").find(".card").find(".card-content").find("#" + id).parent().parent().css("display", "none");

	var myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	var ck_index;
	//find checkout index in myCheckouts storage
	for(var i = 0; i < myCheckouts.length; i++) {
		if(myCheckouts[i].id == checkout.id) {
			ck_index = i;
			break;
		}
	}

	//remove from array
	myCheckouts.splice(ck_index, 1);

	//save changes in localStorage
	localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));

	var ck_content = JSON.parse(checkout.content);
	ck_content.status = 2;
	checkout.content = JSON.stringify(ck_content);
	checkouts = [checkout];
	Materialize.toast("Checkout completed.", 2500);
	pushCheckouts(checkouts);
}

//uploads all checkouts in myCheckouts
function uploadMyCheckouts(release) {
	var myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	if(release && myCheckouts.length != 0) {
		//change checkout status' to available
		for(var i = 0; i < myCheckouts.length; i++) {
			var ck_content = JSON.parse(myCheckouts[i].content);
			ck_content.status = 0;
			myCheckouts[i].content = JSON.stringify(ck_content);
		}
	}

	if(myCheckouts.length != 0) {
		pushCheckouts(myCheckouts);
	}
}


//opens checkout in edit_data.html
function openCheckout(id, ck_out) {

	var eurl = 'edit_data.html';
	if(ck_out == true) {
		var checkout = $("#my_checkouts").find("#" + id).attr("checkout");
	} else {
		var checkout = $("#checkouts").find("#" + id).attr("checkout");
	}
	localStorage.setItem("editing_checkout", JSON.stringify([checkout, ck_out]));

	window.location.replace(eurl);
}

//adds checkout to myCheckouts localStorage item
function checkout(id) {

	//load myCheckouts array
	var myCheckouts = [];
	if(localStorage.getItem("myCheckouts") === null) {
		localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));
	}else {
		myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	}

	//get checkout to checkout
	var myCheckout = JSON.parse($("#" + id).attr("checkout"));

	//make sure checkout is not already checked out
	var available = false;
	var unique = false;
	var j = 0;
	do {
		if(myCheckouts.length == 0) {
			unique = true;
		}else if(myCheckout.id != myCheckouts[j].id) {
			unique = true;
		}else {
			unique = false; break;
		}
		j++;
	}while(j < myCheckouts.length);

	// if(!unique || myCheckout.status == 1 ||  myCheckout.status == 2) { available = false; } else { available = true; }
	if(!unique) { available = false; } else { available = true; }

	if (available) {
		//add checkout to array with updated status and name tag
		myCheckoutContent = JSON.parse(myCheckout.content);
		myCheckoutContent.nameTag = localStorage.getItem("username");
		myCheckoutContent.status = 1;
		myCheckout.content = JSON.stringify(myCheckoutContent);
		myCheckouts[myCheckouts.length] = myCheckout;

		//serialize and store array
		localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));

		//notify
		var myCheckout_content = JSON.parse(myCheckout.content);
		Materialize.toast(myCheckout_content.team.name + " " + myCheckout_content.team.tabs[0].matchType + " " + myCheckout_content.team.tabs[0].matchOrder + " has been checked out to " + localStorage.getItem("username"), 2500);
	}else {
		Materialize.toast("Already checked out", 2500);
	}

	uploadMyCheckouts(false);//sync status' with the server

}

//loads myCheckouts localStorage item into my_checkouts div
function loadMyCheckouts(start, limit) {

	//Clear my_checkouts div
	if(start == 0) {
		$("#my_checkouts").html("");
	}

	//load checkouts from myCheckouts localStorage item into my_checkouts div
	var checkouts = [];
	if(localStorage.getItem("myCheckouts") != null) { checkouts = JSON.parse(localStorage.getItem("myCheckouts")) }
	if(limit > checkouts.length) { limit = checkouts.length; }
	for(var i = start; i < limit; i++) {

		var checkout = checkouts[i];
		var checkout_content = JSON.parse(checkouts[i].content);

		var status;
		if(checkout_content.status == 0 || checkout.status == -1) {
			status = "Available";
		}
		if (checkout_content.status == 1) {
			status = "Checked out to " + checkout_content.nameTag;
		}
		if (checkout_content.status == 2) {
			status = "Completed"
		}
		var params = {
			team: checkout_content.team.name,
			type: checkout_content.team.tabs[0].matchType,
			match_order: checkout_content.team.tabs[0].matchOrder,
			cardColor: cardColor,
			available: status,
			onclick: "openCheckout(" + checkout.id + ", true);",
			checked_out: true,
			checkout: JSON.stringify(checkout),
			id: checkout.id
		};
		$("#my_checkouts").html($("#my_checkouts").html() + get_checkout(params));
	}
	if(limit != checkouts.length) {
		$("#my_checkouts").html($("#my_checkouts").html() + get_load_more(limit, limit + 30, true));
	}

}


//returns checkout html to the specifications of params
function get_checkout(params) {

if(params.type != "PIT") { var title = params.type + " " + params.match_order; } else { var title = "PIT"; } //checkout title
if(params.checked_out) { var icon = "cloud_upload"; } else { var icon = "add"; } //icon name
if(params.checked_out) { var ua_function = "completeCheckout(" + params.id + ");"; } else { var ua_function = "checkout(" + params.id + "); loadMyCheckouts(0, 30);"; } // upload/add function

return ' \
	<div class="card blue-grey darken-1" style="background: ' + params.cardColor + ' !important;"> \
		<div class="card-content white-text"> \
			<div checkout=\'' + params.checkout + '\' id="' + params.id + '" onclick="' + params.onclick + '"> \
				<span style="color: #FFF;" class="card-title">' + params.team + '</span> \
				<p style="color: #FFF;">' + title + '</p> \
				<p style="color: #FFF;">' + params.available + '</p> \
			</div> \
			<a style="background: #2A2A2A; position: absolute; bottom: 10px; right: 10px;" onclick="' + ua_function + '" class="btn-floating btn-large waves-effect waves-light"><i class="material-icons">' + icon + ' \
			</i></a> \
		</div> \
	</div> \
';

}

function get_load_more(start, limit, ck_out) {
	if(ck_out) {
		return '<div class=\'lm_ck\' onclick=\'loadMyCheckouts(' + start + ', ' + limit + '); $(".lm_ck").css("display", "none");\' style=\'width: 100%; text-align: center;\'><p style=\'color: #fff; padding: 14px 0;\'>Load more</p></div>';
	} else {
		return '<div class=\'lm\' onclick=\'loadCheckouts(' + start + ', ' + limit + '); $(".lm").css("display", "none");\' style=\'width: 100%; text-align: center;\'><p style=\'color: #fff; padding: 14px 0;\'>Load more</p></div>';
	}
}

//translates autoCheckoutMode setting from number to title
function getAutoCheckoutModeString(ac_mode) {
	if (ac_mode == 0) { return null; }
	else if (ac_mode == 1) { return "Red Device 1"; }
	else if (ac_mode == 2) { return "Red Device 2"; }
	else if (ac_mode == 3) { return "Red Device 3"; }
	else if (ac_mode == 4) { return "Blue Device 1"; }
	else if (ac_mode == 5) { return "Blue Device 2"; }
	else if (ac_mode == 6) { return "Blue Device 3"; }
	else if (ac_mode == 7) { return "Pit"; }
	else { return null; }
}


//Checks if settings are set in localStorage. If they are not, set them to the defaults.
function loadDefaultsIfNeeded() {
	$.getJSON("../default_settings.json", function(json) {
		if (localStorage.getItem("username") == "") { localStorage.setItem("username", json.username); }
		if (localStorage.getItem("serverIp") == "") { localStorage.setItem("serverIp", json.serverIp); }
		if (localStorage.getItem("teamCode") == "") { localStorage.setItem("teamCode", json.teamCode); }
		if (localStorage.getItem("autoCheckoutMode") == "") { localStorage.setItem("autoCheckoutMode", json.autoCheckoutMode); }
	});
}



</script>


 <!--Import jQuery before materialize.js-->
 <script type="text/javascript" src="materialize/js/materialize.min.js"></script>

<!-- import server_request.js -->
<script type="text/javascript" src="js/server_requests.js"></script>


</body>

</html>