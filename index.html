<!DOCTYPE html>
<html>
<head>
	<title>Roblu Scouter Web Interface </title>

	<!-- Materilize -->
	<!--Import Google Icon Font-->
  	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen,projection"/>


  	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<!-- import jquery -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>
<body>
 	<nav class="nav-extended" style="position: fixed; top: 0; left: 0; z-index: 1000;">
 		<div class="nav-wrapper">
      		<a href="#" id="title" style="font-size: 1.6rem; padding: 20px 0 5px 20px; display: block; line-height: 1.6rem;"><br></a>
      		<a href="#" id="active_event_label" style="font-size: 1.1rem; padding: 0 0 10px 25px; display: block; line-height: 1.1rem;"><br></a>

      		<!-- settings button and menu -->
			<a href="#" id="settings_button" data-activates='settings_list' class="dropdown-button" style="position: absolute; top: 5px; right: 15px;"><i class="material-icons">more_vert</i></a>
      		<ul style="margin-top: 20px; margin-right: 30px; background: #546E7A; min-width: 250px;" id="settings_list" class="dropdown-content"><style type="text/css">#settings_list li a { color: #FFF; }</style>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts(0, 30)" class="filled-in checkbox-color" id="show_pit_checkouts" checked="checked" />
						<label style="color: #FFF;" for="show_pit_checkouts">Show pit checkouts</label>
					</a>
      			</li>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts(0, 30)" class="filled-in checkbox-color" id="show_completed_checkouts" checked="checked"/>
						<label style="color: #FFF;" for="show_completed_checkouts">Show completed</label>
					</a>
      			</li>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts(0, 30)" class="filled-in checkbox-color" id="show_checked_out" checked="checked"/>
						<label style="color: #FFF;" for="show_checked_out">Show checked out</label>
					</a>
      			</li>
      			<li><a id="settings" href="settings.html">Settings</a></li>
      		</ul>
      		<!-- change textbox color -->
      		<style type="text/css">
      			.checkbox-color[type='checkbox'].filled-in:checked + label:after {
      				background: #444;
      				border: #444;
      			}
      		</style>

  		</div>

  		<!-- tab selector -->
	    <div class="nav-content">
	      <ul class="tabs tabs-transparent">
	        <li class="tab"><a id="mc_a" href="#my_checkouts">My Checkouts</a></li>
	        <li class="tab"><a id="c_a" class="active" href="#checkouts">Checkouts</a></li>
	      </ul>
	    </div>
 	</nav><br><br><br><br><br><br>

 	<!-- "Checkouts" tab -->
 	<div id="checkouts" class="col s12" style="margin: 0 3% 0 3%;"></div>
 	<!-- "My Checkouts" tab -->
 	<div id="my_checkouts" class="col s12" style="margin: 0 3% 0 3%;"></div>


<!-- UI -->
<script type="text/javascript">

	// UI setting defaults
	var primaryColor = "#3F51B5";
	var cardColor = "#444444";
	var backgroundColor = "#303030";


	$(document).ready(function() {


		//set correct tab to active
		var eurl = new URL(window.location.href);
		if (eurl.searchParams.get("tab") == "myCheckouts") {
			$("#mc_a").attr("class", "active");
		}

		// Make sure browser is compatible with settings storage method (localStorage)
		if(typeof(Storage) === "undefined") {
			window.location.replace("error.html");
		}else {
			loadDefaultsIfNeeded();
		}

		// initialize settings dropdown
		$('.dropdown-button').dropdown({
			inDuration: 300,
			outDuration: 225,
			constrainWidth: false,
			hover: false,
			gutter: 0,
			belowOrigin: true,
			alignment: 'right',
			stopPropagation: false
		});


		// set Ui colors
		$(".card").attr("style", "background: " + cardColor + " !important;");
		$("nav").attr("style", $("nav").attr("style") + " background: " + primaryColor + " !important;");
		$("body").attr("style", "background: " + backgroundColor + " !important;");
		$("#settings_list").attr("style", $("#settings_list").attr("style") + " background-color: " + backgroundColor + " !important;");

		// Set active event name from server
		getTeamModel( function(data) {
			$("#active_event_label").text(data.active_event_name);
		});

		// Set scouter role from settings
		var title = "Roblu Scouter";
		if (localStorage.getItem("autoCheckoutMode") != 0) {
			title += " - " + getAutoCheckoutModeString(localStorage.getItem("autoCheckoutMode"));
		}
		$("#title").text(title);

		loadCheckouts(0, 30); //load main checkouts from server
		autoCheckout(); //add checkouts with matching autoCheckoutMode to myCheckouts localStorage item
		loadMyCheckouts(0, 30); //load checkouts from myCheckouts localStorage item into my_checkous div
 	});

</script>

<script type="text/javascript">

// loads checkouts from the server into the checkouts div
function loadCheckouts(start, limit) {

	//Clear checkouts div
	if(start == 0) {
		$("#checkouts").html("");
	}

	//Get settings from checkboxes
	var show_pit_checkouts = $("#show_pit_checkouts").is(':checked');
	var show_completed_checkouts = $("#show_completed_checkouts").is(':checked');
	var show_checked_out = $("#show_checked_out").is(':checked');

	//load checkouts from server into checkouts div

	getCheckouts(show_pit_checkouts, show_completed_checkouts, show_checked_out, '0', function( checkouts ) {

		if(limit >= checkouts.length) { limit = checkouts.length; }

		for(var i = start; i <= limit; i++) {

			st = i;
			if (st == limit) { st--; }//so the load_more request has valid data


			if(!(i == limit && limit == checkouts.length)) {
				var checkout = checkouts[st];
				var checkout_content = JSON.parse(checkouts[st].content);

				var status;
				if(checkout.status == 0 || checkout.status == -1) {
					status = "Available";
				}
				if (checkout.status == 1) {
					status = "Checked out to " + checkout_content.nameTag;
				}
				if (checkout.status == 2) {
					status = "Completed"
				}
				$.ajax({
					type: 'POST',
					data: {
						team: checkout_content.team.name,
						type: checkout_content.team.tabs[0].matchType,
						match_order: checkout_content.team.tabs[0].matchOrder,
						card_color: cardColor,
						available: status,
						onclick: "openCheckout(" + checkout.id + ", false);",
						checked_out: 0,
						checkout: JSON.stringify(checkout),
						id: checkout.id,
						last: i == limit,
						limit: limit
					},
					url: 'cards/get_checkout.php'
				}).done( function(data) {
					$("#checkouts").html($("#checkouts").html() + data);
				});
			}
		}
	});
}


//adds all checkouts with the matching device role to myCheckouts (must be run after checkouts are loaded into the page)
function autoCheckout() {
	if(localStorage.getItem("autoCheckoutModeTemp") != localStorage.getItem("autoCheckoutMode")) {

		//remove old device role checkouts
		localStorage.removeItem("myCheckouts");
		localStorage.setItem("autoCheckoutModeTemp", localStorage.getItem("autoCheckoutMode"));

		if(localStorage.getItem("autoCheckoutMode") != '0') {
		
			getCheckouts(true, true, true, localStorage.getItem("autoCheckoutMode"), function( checkouts ) {
				for(var i = 0; i < checkouts.length; i++) {
					//load myCheckouts array
					var my_checkouts = [];
					if(localStorage.getItem("myCheckouts") === null) {
						localStorage.setItem("myCheckouts", JSON.stringify(my_checkouts));
					}else {
						my_checkouts = JSON.parse(localStorage.getItem("myCheckouts"));
					}

					//make sure checkout is not already checked out
					var available = false;
					var unique = false;
					var j = 0;
					do {
						if(my_checkouts.length == 0) {
							unique = true;
						}else if(checkouts[i].id != my_checkouts[j].id) {
							unique = true;
						}else {
							unique = false; break;
						}
						j++;
					}while(j < my_checkouts.length);

					// if(!unique || checkouts[i].status == 1 ||  checkouts[i].status == 2) { available = false; } else { available = true; }
					if(!unique) { available = false; } else { available = true; }

					if(available) {
						//update status
						checkouts[i].status = 1;
						var ck_content = JSON.parse(checkouts[i].content);
						ck_content.status = 1;
						checkouts[i].content = JSON.stringify(ck_content);
						checkouts[i].nameTag = localStorage.getItem("username");
						//add checkout to array
						my_checkouts[my_checkouts.length] = checkouts[i];

						//serialize and store array
						localStorage.setItem("myCheckouts", JSON.stringify(my_checkouts));
					}
				}
				loadMyCheckouts(0, 30); //refresh html
				uploadMyCheckouts(); //sync status' with server
			});
		}
	}
}

//upload a single checkout with status 2
function completeCheckout(id) {
	var checkout = JSON.parse($("#my_checkouts").find(".card").find(".card-content").find("#" + id).attr("checkout"));
	$("#my_checkouts").find(".card").find(".card-content").find("#" + id).parent().parent().css("display", "none");

	var myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	var ck_index;
	//find checkout index in myCheckouts storage
	for(var i = 0; i < myCheckouts.length; i++) {
		if(myCheckouts[i].id == checkout.id) {
			ck_index = i;
			break;
		}
	}

	//remove from array
	myCheckouts.splice(ck_index, 1);

	//store in localStorage
	localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));

	checkout.status = 2;
	checkouts = [checkout];
	Materialize.toast("Checkout completed.", 2500);
	pushCheckouts(checkouts);
}

//uploads all checkouts in myCheckouts
function uploadMyCheckouts() {
	var myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	if(myCheckouts.length != 0) {
		pushCheckouts(myCheckouts);
	}
}


//opens checkout in edit_data.html
function openCheckout(id, ck_out) {

	var eurl = 'edit_data.html';
	if(ck_out == true) {
		var checkout = $("#my_checkouts").find("#" + id).attr("checkout");
	} else {
		var checkout = $("#checkouts").find("#" + id).attr("checkout");
	}
	localStorage.setItem("editing_checkout", JSON.stringify([checkout, ck_out]));

	window.location.replace(eurl);
}

//adds checkout to myCheckouts localStorage item
function checkout(id) {

	//load myCheckouts array
	var myCheckouts = [];
	if(localStorage.getItem("myCheckouts") === null) {
		localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));
	}else {
		myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	}

	//get checkout to checkout
	var myCheckout = JSON.parse($("#" + id).attr("checkout"));

	//make sure checkout is not already checked out
	var available = false;
	var unique = false;
	var j = 0;
	do {
		if(myCheckouts.length == 0) {
			unique = true;
		}else if(myCheckout.id != myCheckouts[j].id) {
			unique = true;
		}else {
			unique = false; break;
		}
		j++;
	}while(j < myCheckouts.length);

	// if(!unique || myCheckout.status == 1 ||  myCheckout.status == 2) { available = false; } else { available = true; }
	if(!unique) { available = false; } else { available = true; }

	if (available) {
		//add checkout to array with updated status and name tag
		myCheckout.status = 1;
		myCheckoutContent = JSON.parse(myCheckout.content);
		myCheckoutContent.nameTag = localStorage.getItem("username");
		myCheckoutContent.status = 1;
		myCheckout.content = JSON.stringify(myCheckoutContent);
		myCheckouts[myCheckouts.length] = myCheckout;

		//serialize and store array
		localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));

		//notify
		var myCheckout_content = JSON.parse(myCheckout.content);
		Materialize.toast(myCheckout_content.team.name + " " + myCheckout_content.team.tabs[0].matchType + " " + myCheckout_content.team.tabs[0].matchOrder + " has been checked out to " + localStorage.getItem("username"), 2500);
	}else {
		Materialize.toast("Already checked out", 2500);
	}

	uploadMyCheckouts();//sync status' with the server

}

//loads myCheckouts localStorage item into my_checkouts div
function loadMyCheckouts(start, limit) {
	if(start == 0) {
		$("#my_checkouts").html("");
	}

	var myCheckouts = [];
	if(localStorage.getItem("myCheckouts") != null) { myCheckouts = JSON.parse(localStorage.getItem("myCheckouts")) }

	if(limit >= myCheckouts.length) { limit = myCheckouts.length; }

	var st = 0;
	for(var i = start; i <= limit; i++) {

		st = i;
		if (st == limit) { st--; }//so the load_more request has valid data

		//check if there are checkouts to be loaded on last iteration
		if(!(i == limit && limit == myCheckouts.length)) {
			var myCheckout = myCheckouts[st];
			var myCheckout_content = JSON.parse(myCheckouts[st].content);

			$.ajax({
				type: 'POST',
				data: {
					team: myCheckout_content.team.name,
					type: myCheckout_content.team.tabs[0].matchType,
					match_order: myCheckout_content.team.tabs[0].matchOrder,
					card_color: cardColor,
					available: "Checked out to " + localStorage.getItem("username"),
					onclick: "openCheckout(" + myCheckout.id + ", true);",
					checked_out: 1,
					checkout: JSON.stringify(myCheckout),
					id: myCheckout.id,
					last: i == limit,
					limit: limit
				},
				url: 'cards/get_checkout.php'
			}).done( function(data) {
					$("#my_checkouts").html($("#my_checkouts").html() + data);
			});
		}
	}
}

//translates autoCheckoutMode setting from number to title
function getAutoCheckoutModeString(ac_mode) {
	if (ac_mode == 0) { return null; }
	else if (ac_mode == 1) { return "Red Device 1"; }
	else if (ac_mode == 2) { return "Red Device 2"; }
	else if (ac_mode == 3) { return "Red Device 3"; }
	else if (ac_mode == 4) { return "Blue Device 1"; }
	else if (ac_mode == 5) { return "Blue Device 2"; }
	else if (ac_mode == 6) { return "Blue Device 3"; }
	else if (ac_mode == 7) { return "Pit"; }
	else { return null; }
}


//Checks if settings are set in localStorage. If they are not, set them to the defaults.
function loadDefaultsIfNeeded() {
	$.getJSON("../default_settings.json", function(json) {
		if (localStorage.getItem("username") === "undefined") { localStorage.setItem("username", json.username); }
		if (localStorage.getItem("serverIp") === "undefined") { localStorage.setItem("serverIp", json.serverIp); }
		if (localStorage.getItem("teamCode") === "undefined") { localStorage.setItem("teamCode", json.teamCode); }
		if (localStorage.getItem("autoCheckoutMode") === "undefined") { localStorage.setItem("autoCheckoutMode", json.autoCheckoutMode); }
	});
}



</script>


 <!--Import jQuery before materialize.js-->
 <script type="text/javascript" src="materialize/js/materialize.min.js"></script>

<!-- import server_request.js -->
<script type="text/javascript" src="js/server_requests.js"></script>

</body>

</html>