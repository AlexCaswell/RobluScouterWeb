<!DOCTYPE html>
<html>
<head>
	<title>Roblu Scouter Web Interface </title>

	<!-- Materilize -->
	<!--Import Google Icon Font-->
  	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen,projection"/>


  	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<!-- import jquery -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>
<body>
 	<nav class="nav-extended" style="position: fixed; top: 0; left: 0; z-index: 1000;">
 		<div class="nav-wrapper">
      		<a href="#" id="title" style="font-size: 1.6rem; padding: 20px 0 5px 20px; display: block; line-height: 1.6rem;"><br></a>
      		<a href="#" id="active_event_label" style="font-size: 1.1rem; padding: 0 0 10px 25px; display: block; line-height: 1.1rem;"><br></a>

      		<!-- settings button and menu -->
			<a href="#" id="settings_button" data-activates='settings_list' class="dropdown-button" style="position: absolute; top: 5px; right: 15px;"><i class="material-icons">more_vert</i></a>
      		<ul style="margin-top: 20px; margin-right: 30px; background: #546E7A; min-width: 250px;" id="settings_list" class="dropdown-content"><style type="text/css">#settings_list li a { color: #FFF; }</style>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts()" class="filled-in checkbox-color" id="show_pit_checkouts" checked="checked" />
						<label style="color: #FFF;" for="show_pit_checkouts">Show pit checkouts</label>
					</a>
      			</li>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts()" class="filled-in checkbox-color" id="show_completed_checkouts" />
						<label style="color: #FFF;" for="show_completed_checkouts">Show completed</label>
					</a>
      			</li>
      			<li>
					<a>
						<input type="checkbox" onclick="loadCheckouts()" class="filled-in checkbox-color" id="show_checked_out" />
						<label style="color: #FFF;" for="show_checked_out">Show checked out</label>
					</a>
      			</li>
      			<li><a id="my_matches" href="mymatches.html">My matches</a></li>
      			<li><a id="settings" href="settings.html">Settings</a></li>
      		</ul>
      		<!-- change textbox color -->
      		<style type="text/css">
      			.checkbox-color[type='checkbox'].filled-in:checked + label:after {
      				background: #444;
      				border: #444;
      			}
      		</style>

  		</div>

  		<!-- tab selector -->
	    <div class="nav-content">
	      <ul class="tabs tabs-transparent">
	        <li class="tab"><a href="#my_checkouts">My Checkouts</a></li>
	        <li class="tab"><a class="active" href="#checkouts">Checkouts</a></li>
	      </ul>
	    </div>
 	</nav><br><br><br><br><br><br>

 	<!-- "Checkouts" tab -->
 	<div id="checkouts" class="col s12" style="margin: 0 3% 0 3%;"></div>
 	<!-- "My Checkouts" tab -->
 	<div id="my_checkouts" class="col s12" style="margin: 0 3% 0 3%;"></div>


<!-- UI -->
<script type="text/javascript">

	// UI setting defaults
	var primaryColor = "#3F51B5";
	var cardColor = "#444444";
	var backgroundColor = "#303030";


	$(document).ready(function() {


		// Make sure browser is compatible with settings storage method (localStorage)
		if(typeof(Storage) === "undefined") {
			window.location.replace("error.html");
		}else {
			loadDefaultsIfNeeded();
		}

		// initialize settings dropdown
		$('.dropdown-button').dropdown({
			inDuration: 300,
			outDuration: 225,
			constrainWidth: false,
			hover: false,
			gutter: 0,
			belowOrigin: true,
			alignment: 'right',
			stopPropagation: false
		});


		// set Ui colors
		$(".card").attr("style", "background: " + cardColor + " !important;");
		$("nav").attr("style", $("nav").attr("style") + " background: " + primaryColor + " !important;");
		$("body").attr("style", "background: " + backgroundColor + " !important;");
		$("#settings_list").attr("style", $("#settings_list").attr("style") + " background-color: " + backgroundColor + " !important;");

		// Set active event name from server
		getTeamModel( function(data) {
			$("#active_event_label").text(data.active_event_name);
		});

		// Set scouter role from settings
		var title = "Roblu Scouter";
		if (localStorage.getItem("autoCheckoutMode") != 0) {
			title += " - " + getAutoCheckoutModeString(localStorage.getItem("autoCheckoutMode"));
		}
		$("#title").text(title);

		loadCheckouts();
		loadMyCheckouts();


 	});

</script>

<script type="text/javascript">

// loads checkouts from the server into the checkouts div
function loadCheckouts() {

	//Clear checkouts div
	$("#checkouts").html("");

	//Get settings from checkboxes
	var show_pit_checkouts = $("#show_pit_checkouts").is(':checked');
	var show_completed_checkouts = $("#show_completed_checkouts").is(':checked');
	var show_checked_out = $("#show_checked_out").is(':checked');

	//load checkouts from server into checkouts div

	getCheckouts(show_pit_checkouts, show_completed_checkouts, show_checked_out, localStorage.getItem("autoCheckoutMode"), function( checkouts ) {
		for(var i = 0; i < checkouts.length; i++) {
			var checkout = checkouts[i];
			var checkout_content = JSON.parse(checkouts[i].content);

			var status;
			if(checkout.status == 0 || checkout.status == -1) {
				status = "Available";
			}
			if (checkout.status == 1) {
				status = "Checked out to " + checkout_content.nameTag;
			}
			if (checkout.status == 2) {
				status = "Completed"
			}

			$.ajax({
				type: 'POST',
				data: {
					team: checkout_content.team.name,
					type: checkout_content.team.tabs[0].matchType,
					match_order: checkout_content.team.tabs[0].matchOrder,
					card_color: cardColor,
					available: status,
					onclick: "openCheckout(" + checkout.id + ", false);",
					checked_out: 0,
					checkout: JSON.stringify(checkout),
					id: checkout.id
				},
				url: 'cards/get_checkout.php'
			}).done( function(data) {
					$("#checkouts").html($("#checkouts").html() + data);
			});
		}
	});

}

//opens checkout in edit_data.html
function openCheckout(id, ck_out) {
	if(ck_out == true) {
		var req_url = "edit_data.html?checkout=" + $("#my_checkouts").find("#" + id).attr("checkout") + "&checked_out=" + ck_out;
	} else {
		var req_url = "edit_data.html?checkout=" + $("#checkouts").find("#" + id).attr("checkout") + "&checked_out=" + ck_out;
	}

	window.location.replace(req_url);
}

//adds checkout to myCheckouts localStorage item
function checkout(id) {

	//load myCheckouts array
	var myCheckouts = [];
	if(localStorage.getItem("myCheckouts") === null) {
		localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));
	}else {
		myCheckouts = JSON.parse(localStorage.getItem("myCheckouts"));
	}

	//get checkout to checkout
	var myCheckout = JSON.parse($("#" + id).attr("checkout"));

	//make sure checkout is not already checked out
	var unique = true;
	for(var i = 0; i < myCheckouts.length; i++) {
		if(myCheckout.id == myCheckouts[i].id) { unique = false; }
	}

	if (unique) {
		//add checkout to array
		myCheckouts[myCheckouts.length] = myCheckout;

		//serialize and store array
		localStorage.setItem("myCheckouts", JSON.stringify(myCheckouts));

		var myCheckout_content = JSON.parse(myCheckout.content);
		Materialize.toast(myCheckout_content.team.name + " " + myCheckout_content.team.tabs[0].matchType + " " + myCheckout_content.team.tabs[0].matchOrder + " has been checked out to " + localStorage.getItem("username"), 2500);
	}else {
		Materialize.toast("Already checked out", 2500);
	}

}

//loads myCheckouts localStorage item into my_checkouts div
function loadMyCheckouts() {

	$("#my_checkouts").html("");

	var myCheckouts = [];
	if(localStorage.getItem("myCheckouts") != null) { myCheckouts = JSON.parse(localStorage.getItem("myCheckouts")) }
	for(var i = 0; i < myCheckouts.length; i++) {
		var myCheckout = myCheckouts[i];
		var myCheckout_content = JSON.parse(myCheckouts[i].content);

		$.ajax({
			type: 'POST',
			data: {
				team: myCheckout_content.team.name,
				type: myCheckout_content.team.tabs[0].matchType,
				match_order: myCheckout_content.team.tabs[0].matchOrder,
				card_color: cardColor,
				available: "Checked out to " + localStorage.getItem("username"),
				onclick: "openCheckout(" + myCheckout.id + ", true);",
				checked_out: 1,
				checkout: JSON.stringify(myCheckout),
				id: myCheckout.id
			},
			url: 'cards/get_checkout.php'
		}).done( function(data) {
				$("#my_checkouts").html($("#my_checkouts").html() + data);
		});
	}
}



</script>


 <!--Import jQuery before materialize.js-->
 <script type="text/javascript" src="materialize/js/materialize.min.js"></script>

<!-- import server_request.js -->
<script type="text/javascript" src="js/server_requests.js"></script>

<!-- import util_functions.js -->
<script type="text/javascript" src="js/util_functions.js"></script>

</body>

</html>